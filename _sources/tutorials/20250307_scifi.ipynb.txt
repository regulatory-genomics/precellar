{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "c56d9578",
   "metadata": {},
   "source": [
    "## Set up"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "id": "a921aed4-8664-4691-91ca-4fad740412c7",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "'0.3.0-dev0'"
      ]
     },
     "execution_count": 22,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import precellar\n",
    "precellar.__version__"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4e4718e1",
   "metadata": {},
   "source": [
    "## Prepare seqspec and read"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ad699c02",
   "metadata": {},
   "source": [
    "We made seqspec template base on https://teichlab.github.io/scg_lib_structs/methods_html/scifi-ATAC-seq.html"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "9e950c03-7071-4582-867b-d80936863c98",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Modality ATAC has nesting depth: 1\n"
     ]
    }
   ],
   "source": [
    "assay = precellar.Assay(\"seqspec_template/scifi_atac.yaml\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "b774a415-ab74-42d6-8228-243a20fb18aa",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "scifi_atac\n",
       "└── atac(200-2000)\n",
       "    ├── illumina_p5(29) [↓I2(16)✗]\n",
       "    ├── gem_barcode(16)\n",
       "    ├── custom_read1(32) [↓R1(74-100)✗]\n",
       "    ├── tn5_index_A(5)\n",
       "    ├── mosaic_end_1(19)\n",
       "    ├── gdna(1-1800)\n",
       "    ├── mosaic_end_2(19)\n",
       "    ├── tn5_index_B(5)\n",
       "    ├── custom_read2(34) [↑R2(74-100)✗]\n",
       "    ├── sample_index(8)\n",
       "    └── illumina_p7(24) [↑I1(8)✗]"
      ]
     },
     "execution_count": 9,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "assay"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b76257b9-1843-4148-88cd-9f72a9ffa7ef",
   "metadata": {},
   "source": [
    "The data is downloaded from https://www.ncbi.nlm.nih.gov/sra/?term=SRR25320539."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "f14c2fb5-b000-4904-acd2-2b2cfef73526",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "@SRR25320539.1 A00201R:718:HYKV2DSX3:3:1101:2437:1016 length=151\n",
      "CGCGAAGATGTGTATAAGAGACAGATAAAACAAAAAACGCCCACATCAAAATGAGTTATTCAAAGCAACATTCCAAGTCATCTAGTTGACAAACTCTATCACTCACAACAAACTATATTAAAATATCCATCCTATACACAAGACTTAGACA\n",
      "+SRR25320539.1 A00201R:718:HYKV2DSX3:3:1101:2437:1016 length=151\n",
      "FFFFFFFFFFFFFFFFFFFFFFFFF,,,,F,,,,FF,:F,FFF,,,:F:FF,,,F:,F,::,:::F:F:F,,,F::,FFFF:F:FF,F:::,F:F:,:FF,F::,FFF,,:,,,::F,F,F,:FFFFFF,FFFFFF:F:F:,F,FFF,,FF\n",
      "zstd: error 70 : Write error : cannot write block : Broken pipe \n"
     ]
    }
   ],
   "source": [
    "!zstdcat /data2/litian/precellar_temp/scifi-ATAC/SRR25320539/SRR25320539_2.fastq.zst | head -n 4"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "7161794c-febe-4412-a315-303d2f5c5f42",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "@SRR25320539.1 A00201R:718:HYKV2DSX3:3:1101:2437:1016 length=151\n",
      "CTATCAGATGTGTATAAGAGACAGGCTATAAATAGATTTCTCTAGCTTTTTATGCACTTTTTTCTGTTGTAGTGTACTACGCCTAGTGTATATGAGGTATCAATGATGATATGTGGATTGGATGTCTCGCGTATGTCAACTAGAGGGAATT\n",
      "+SRR25320539.1 A00201R:718:HYKV2DSX3:3:1101:2437:1016 length=151\n",
      "FFF:,:::FFFFFFFFFFFFFFF:,,,,:,FFF,,,,:,::,F,,F,,FF:,,,FF,FF,,,F,,F,,F:F:,,,F,F,,,,,,,,F,FF,,,FF:,,F:F:,,F:,,,FFF,,,F,,,:,F,,,F:F,,,FF,,,:FF,,F,,:,,,,F,\n",
      "zstd: error 70 : Write error : cannot write block : Broken pipe \n"
     ]
    }
   ],
   "source": [
    "!zstdcat /data2/litian/precellar_temp/scifi-ATAC/SRR25320539/SRR25320539_4.fastq.zst | head -n 4"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "b35318c6-fdbf-4a19-80b2-e194a34af438",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "@SRR25320539.1 A00201R:718:HYKV2DSX3:3:1101:2437:1016 length=8\n",
      "CTCGTACT\n",
      "+SRR25320539.1 A00201R:718:HYKV2DSX3:3:1101:2437:1016 length=8\n",
      ",:F,FFFF\n",
      "zstd: error 70 : Write error : cannot write block : Broken pipe \n"
     ]
    }
   ],
   "source": [
    "!zstdcat /data2/litian/precellar_temp/scifi-ATAC/SRR25320539/SRR25320539_1.fastq.zst | head -n 4"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "id": "29870d85-83ab-492d-99b5-f71e7836bb8e",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "@SRR25320539.1 A00201R:718:HYKV2DSX3:3:1101:2437:1016 length=16\n",
      "GGTCTTCACGATCCTC\n",
      "+SRR25320539.1 A00201R:718:HYKV2DSX3:3:1101:2437:1016 length=16\n",
      ":F:,,,,,,,FFF,,,\n",
      "zstd: error 70 : Write error : cannot write block : Broken pipe \n"
     ]
    }
   ],
   "source": [
    "!zstdcat /data2/litian/precellar_temp/scifi-ATAC/SRR25320539/SRR25320539_3.fastq.zst | head -n 4"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "338ec433-e98b-4bed-9f94-d76e675335c7",
   "metadata": {},
   "outputs": [],
   "source": [
    "assay.update_read(\"R1\", fastq=\"/data2/litian/precellar_temp/scifi-ATAC/SRR25320539/SRR25320539_2.fastq.zst\")\n",
    "assay.update_read(\"R2\", fastq=\"/data2/litian/precellar_temp/scifi-ATAC/SRR25320539/SRR25320539_4.fastq.zst\")\n",
    "assay.update_read(\"I1\", fastq=\"/data2/litian/precellar_temp/scifi-ATAC/SRR25320539/SRR25320539_1.fastq.zst\")\n",
    "assay.update_read(\"I2\", fastq=\"/data2/litian/precellar_temp/scifi-ATAC/SRR25320539/SRR25320539_3.fastq.zst\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "23b36ee3-d5eb-4ef0-90cf-781c35a5a947",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "--2025-03-07 17:32:43--  https://ftp.ensemblgenomes.ebi.ac.uk/pub/plants/release-60/fasta/zea_mays/dna/Zea_mays.Zm-B73-REFERENCE-NAM-5.0.dna.toplevel.fa.gz\n",
      "193.62.193.161ensemblgenomes.ebi.ac.uk (ftp.ensemblgenomes.ebi.ac.uk)... \n",
      "connected. to ftp.ensemblgenomes.ebi.ac.uk (ftp.ensemblgenomes.ebi.ac.uk)|193.62.193.161|:443... \n",
      "HTTP request sent, awaiting response... 200 OK\n",
      "Length: 645391865 (615M) [application/x-gzip]\n",
      "Saving to: 'Zea_mays.Zm-B73-REFERENCE-NAM-5.0.dna.toplevel.fa.gz'\n",
      "\n",
      "Zea_mays.Zm-B73-REF 100%[===================>] 615.49M  4.35MB/s    in 1m 47s  \n",
      "\n",
      "2025-03-07 17:34:31 (5.75 MB/s) - 'Zea_mays.Zm-B73-REFERENCE-NAM-5.0.dna.toplevel.fa.gz' saved [645391865/645391865]\n",
      "\n"
     ]
    }
   ],
   "source": [
    "!wget https://ftp.ensemblgenomes.ebi.ac.uk/pub/plants/release-60/fasta/zea_mays/dna/Zea_mays.Zm-B73-REFERENCE-NAM-5.0.dna.toplevel.fa.gz"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "538fe57a-1c10-403d-8b1c-befcba386b93",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ref_seq_len = 4364151988\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "[bwa_index] Pack FASTA... 15.04 sec\n",
      "* Entering FMI_search\n",
      "init ticks = 126244973136\n",
      "ref seq len = 4364151988\n",
      "binary seq ticks = 81294602774\n",
      "build suffix-array ticks = 1536448616796\n",
      "pos: 545518999, ref_seq_len__: 545518998\n",
      "build fm-index ticks = 1348375543496\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "count = 0, 1161389254, 2182075994, 3202762734, 4364151988\n",
      "BWT[3512089108] = 4\n",
      "CP_SHIFT = 6, CP_MASK = 63\n",
      "sizeof CP_OCC = 64\n",
      "max_occ_ind = 68189874\n"
     ]
    }
   ],
   "source": [
    "precellar.make_bwa_index(fasta=\"/data2/litian/database/genome/Zea_mays.Zm-B73-REFERENCE-NAM-5.0.dna.toplevel.fa.gz\",\n",
    "                         genome_prefix=\"/data2/litian/database/bwa/zm/zm\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7bbe7f57",
   "metadata": {},
   "source": [
    "## Alignment"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "bc8d54a9-963a-47b0-a3a9-499c32abd9f4",
   "metadata": {},
   "outputs": [],
   "source": [
    "bwa = precellar.aligners.BWAMEM2(\"/data2/litian/database/bwa/zm/zm\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "f2d62f9a-e14d-4b72-8938-7878aaaf53ea",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "[2025-03-07T10:13:37Z \u001b[32mINFO\u001b[0m] Starting alignment process\n",
      "[2025-03-07T10:13:37Z \u001b[32mINFO\u001b[0m] Using provided Assay object\n",
      "[2025-03-07T10:13:37Z \u001b[32mINFO\u001b[0m] Using modality: ATAC\n",
      "[2025-03-07T10:13:37Z \u001b[32mINFO\u001b[0m] Initialized aligner: BWA-MEM2\n",
      "[2025-03-07T10:13:37Z \u001b[32mINFO\u001b[0m] Initializing FastqProcessor with 32 threads and chunk size 10000000\n",
      "[2025-03-07T10:13:37Z \u001b[32mINFO\u001b[0m] Adding mitochondrial DNA references: [\"chrM\", \"M\"]\n",
      "[2025-03-07T10:13:37Z \u001b[32mINFO\u001b[0m] Generating alignments\n",
      "[2025-03-07T10:13:37Z \u001b[32mINFO\u001b[0m] Using BWA-MEM2 aligner\n",
      "[2025-03-07T10:13:37Z \u001b[32mINFO\u001b[0m] Starting gen_barcoded_alignments with chunk_size=320000000\n",
      "[2025-03-07T10:13:37Z \u001b[32mINFO\u001b[0m] Starting gen_barcoded_fastq for modality: ATAC\n",
      "[2025-03-07T10:13:37Z \u001b[32mINFO\u001b[0m] Counting barcodes...\n",
      "[2025-03-07T10:16:22Z \u001b[32mINFO\u001b[0m] Processing read R1 with 3 segments, is_reverse: false\n",
      "[2025-03-07T10:16:22Z \u001b[32mINFO\u001b[0m] Segment in read R1: type=Barcode, range=0..5, id=tn5_index_A\n",
      "[2025-03-07T10:16:22Z \u001b[32mINFO\u001b[0m] Segment in read R1: type=CustomPrimer, range=5..24, id=mosaic_end_1\n",
      "[2025-03-07T10:16:22Z \u001b[32mINFO\u001b[0m] Segment in read R1: type=Gdna, range=24..151, id=gdna\n",
      "[2025-03-07T10:16:22Z \u001b[32mINFO\u001b[0m] Created annotator for read R1 with 2 subregions\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Processing read R2 with 3 segments, is_reverse: true\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Segment in read R2: type=Barcode, range=0..5, id=tn5_index_B\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Segment in read R2: type=CustomPrimer, range=5..24, id=mosaic_end_2\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Segment in read R2: type=Gdna, range=24..151, id=gdna\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Created annotator for read R2 with 2 subregions\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Processing read I1 with 1 segments, is_reverse: true\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Segment in read I1: type=Barcode, range=0..8, id=sample_index\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Created annotator for read I1 with 1 subregions\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Processing read I2 with 1 segments, is_reverse: false\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Segment in read I2: type=Barcode, range=0..16, id=gem_barcode\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Created annotator for read I2 with 1 subregions\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] FastqReader created. Is paired-end: true\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Number of annotators: 4\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Number of readers: 4\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Barcodes found: [(\"tn5_index_A\", 5), (\"tn5_index_B\", 5), (\"sample_index\", 8), (\"gem_barcode\", 16)]\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] UMIs found: []\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Total reads reported: 65937541\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Aligning 65937541 reads...\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Processing output type: fragment\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Generating fragments\n",
      "[2025-03-07T10:16:23Z \u001b[32mINFO\u001b[0m] Using compression: Some(Zstd) with level: None\n",
      "[2025-03-07T10:16:24Z \u001b[32mINFO\u001b[0m] Created output file: \"/data2/litian/precellar_data//processed_file/20250307_scifi_out.fragment.tsv.zst\"\n",
      "[2025-03-07T10:16:27Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:16:27Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      "  1%|▍         |   981596/65937541 [00:53<59:14, 18273.95it/s][2025-03-07T10:17:21Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:17:21Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      "  3%|▌         |  1963192/65937541 [01:44<56:52, 18745.66it/s][2025-03-07T10:18:12Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:18:12Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      "  4%|▋         |  2944788/65937541 [02:35<55:18, 18983.43it/s][2025-03-07T10:19:02Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:19:02Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      "  6%|▊         |  3926384/65937541 [03:26<54:22, 19007.44it/s][2025-03-07T10:19:55Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:19:55Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      "  7%|▉         |  4907980/65937541 [04:18<53:29, 19018.15it/s][2025-03-07T10:20:45Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:20:45Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      "  9%|█         |  5889576/65937541 [05:08<52:23, 19103.71it/s][2025-03-07T10:21:35Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:21:35Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 10%|█▎        |  6871172/65937541 [05:58<51:23, 19154.03it/s][2025-03-07T10:22:26Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:22:26Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 12%|█▍        |  7852768/65937541 [06:49<50:27, 19187.38it/s][2025-03-07T10:23:17Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:23:17Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 13%|█▌        |  8834364/65937541 [07:40<49:37, 19179.20it/s][2025-03-07T10:24:07Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:24:07Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 15%|█▋        |  9815960/65937541 [08:31<48:43, 19196.59it/s][2025-03-07T10:24:58Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:24:58Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 16%|█▊        | 10797556/65937541 [09:21<47:49, 19214.29it/s][2025-03-07T10:25:49Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:25:49Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 18%|█▉        | 11779152/65937541 [10:12<46:55, 19236.79it/s][2025-03-07T10:26:40Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:26:40Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 19%|██        | 12760748/65937541 [11:03<46:04, 19234.89it/s][2025-03-07T10:27:30Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:27:30Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 21%|██▎       | 13742344/65937541 [11:54<45:11, 19246.32it/s][2025-03-07T10:28:21Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:28:21Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 22%|██▍       | 14723940/65937541 [12:44<44:20, 19249.38it/s][2025-03-07T10:29:12Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:29:12Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 24%|██▌       | 15705536/65937541 [13:35<43:29, 19249.42it/s][2025-03-07T10:30:03Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:30:03Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 25%|██▋       | 16687132/65937541 [14:26<42:36, 19264.75it/s][2025-03-07T10:30:53Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:30:53Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 27%|██▊       | 17668728/65937541 [15:16<41:44, 19274.94it/s][2025-03-07T10:31:44Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:31:44Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 28%|██▉       | 18650324/65937541 [16:08<40:54, 19266.63it/s][2025-03-07T10:32:35Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:32:35Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 30%|███       | 19631920/65937541 [16:58<40:02, 19270.59it/s][2025-03-07T10:33:26Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:33:26Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 31%|███▎      | 20613516/65937541 [17:50<39:12, 19264.94it/s][2025-03-07T10:34:17Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:34:17Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 33%|███▍      | 21595112/65937541 [18:40<38:21, 19267.97it/s][2025-03-07T10:35:08Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:35:08Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 34%|███▌      | 22576708/65937541 [19:31<37:29, 19273.92it/s][2025-03-07T10:35:58Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:35:58Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 36%|███▊      | 23558304/65937541 [20:21<36:37, 19289.00it/s][2025-03-07T10:36:49Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:36:49Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 37%|███▉      | 24539900/65937541 [21:11<35:45, 19292.42it/s][2025-03-07T10:37:39Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:37:39Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 39%|████      | 25521496/65937541 [22:02<34:54, 19298.49it/s][2025-03-07T10:38:30Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:38:30Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 40%|████▎     | 26503092/65937541 [22:53<34:03, 19297.96it/s][2025-03-07T10:39:20Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:39:20Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 42%|████▍     | 27484688/65937541 [23:44<33:12, 19296.86it/s][2025-03-07T10:40:12Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:40:12Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 43%|████▌     | 28466284/65937541 [24:36<32:23, 19284.86it/s][2025-03-07T10:41:03Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:41:03Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 45%|████▋     | 29447880/65937541 [25:27<31:32, 19280.36it/s][2025-03-07T10:41:55Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:41:55Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 46%|████▊     | 30429476/65937541 [26:19<30:42, 19269.23it/s][2025-03-07T10:42:46Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:42:46Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 48%|███���▉     | 31411072/65937541 [27:09<29:51, 19274.96it/s][2025-03-07T10:43:37Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:43:37Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 49%|█████     | 32392668/65937541 [28:00<29:00, 19276.10it/s][2025-03-07T10:44:27Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:44:27Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 51%|█████▎    | 33374264/65937541 [28:51<28:09, 19272.90it/s][2025-03-07T10:45:19Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:45:19Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 52%|█████▍    | 34355860/65937541 [29:42<27:18, 19276.19it/s][2025-03-07T10:46:09Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:46:09Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 54%|█████▌    | 35337456/65937541 [30:33<26:27, 19277.22it/s][2025-03-07T10:47:02Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:47:02Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 55%|█████▋    | 36319052/65937541 [31:25<25:37, 19260.43it/s][2025-03-07T10:47:53Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:47:53Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 57%|█████▊    | 37300648/65937541 [32:15<24:46, 19267.85it/s][2025-03-07T10:48:43Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:48:43Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 58%|█████▉    | 38282244/65937541 [33:06<23:55, 19271.10it/s][2025-03-07T10:49:33Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:49:33Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 60%|██████    | 39263840/65937541 [33:57<23:04, 19271.89it/s][2025-03-07T10:50:25Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:50:25Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 61%|██████▎   | 40245436/65937541 [34:48<22:12, 19274.19it/s][2025-03-07T10:51:15Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:51:15Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 63%|██████▍   | 41227032/65937541 [35:38<21:21, 19280.67it/s][2025-03-07T10:52:06Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:52:06Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 64%|██████▌   | 42208628/65937541 [36:28<20:30, 19284.96it/s][2025-03-07T10:52:56Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:52:56Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 66%|██████▋   | 43190224/65937541 [37:18<19:39, 19293.53it/s][2025-03-07T10:53:45Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:53:45Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 67%|██████▊   | 44171820/65937541 [38:08<18:47, 19298.24it/s][2025-03-07T10:54:36Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:54:36Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 68%|██████▉   | 45153416/65937541 [38:59<17:56, 19299.42it/s][2025-03-07T10:55:27Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:55:27Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 70%|███████   | 46135012/65937541 [39:51<17:06, 19294.05it/s][2025-03-07T10:56:18Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:56:18Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 71%|███████▍  | 47116608/65937541 [40:41<16:15, 19299.81it/s][2025-03-07T10:57:09Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:57:09Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 73%|███████▌  | 48098204/65937541 [41:32<15:24, 19299.72it/s][2025-03-07T10:57:59Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:57:59Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 74%|███████▋  | 49079800/65937541 [42:22<14:33, 19304.06it/s][2025-03-07T10:58:50Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:58:50Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 76%|███████▊  | 50061396/65937541 [43:14<13:42, 19298.42it/s][2025-03-07T10:59:41Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T10:59:41Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 77%|███████▉  | 51042992/65937541 [44:04<12:51, 19303.82it/s][2025-03-07T11:00:32Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:00:32Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 79%|████████  | 52024588/65937541 [44:55<12:00, 19300.44it/s][2025-03-07T11:01:22Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:01:22Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 80%|████████▎ | 53006184/65937541 [45:45<11:09, 19306.14it/s][2025-03-07T11:02:13Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:02:13Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 82%|████████▍ | 53987780/65937541 [46:35<10:18, 19314.14it/s][2025-03-07T11:03:02Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:03:02Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 83%|████████▌ | 54969376/65937541 [47:25<09:27, 19317.45it/s][2025-03-07T11:03:53Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:03:53Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 85%|████████▋ | 55950972/65937541 [48:16<08:36, 19317.56it/s][2025-03-07T11:04:43Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:04:43Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 86%|████████▊ | 56932568/65937541 [49:06<07:46, 19323.17it/s][2025-03-07T11:05:33Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:05:33Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 88%|████████▉ | 57914164/65937541 [49:56<06:55, 19326.31it/s][2025-03-07T11:06:24Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:06:24Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 89%|█████████ | 58895760/65937541 [50:46<06:04, 19331.85it/s][2025-03-07T11:07:14Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:07:14Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 91%|█████████▎| 59877356/65937541 [51:37<05:13, 19330.14it/s][2025-03-07T11:08:05Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:08:05Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 92%|█████████▍| 60858952/65937541 [52:28<04:22, 19329.95it/s][2025-03-07T11:08:56Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:08:56Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 94%|█████████▌| 61840548/65937541 [53:19<03:31, 19330.54it/s][2025-03-07T11:09:46Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:09:46Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 95%|█████████▋| 62822144/65937541 [54:09<02:41, 19332.68it/s][2025-03-07T11:10:37Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:10:37Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 97%|█████████▊| 63803740/65937541 [55:00<01:50, 19328.71it/s][2025-03-07T11:11:28Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:11:28Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      " 98%|█████████▉| 64785336/65937541 [55:50<00:59, 19334.21it/s][2025-03-07T11:12:18Z \u001b[32mINFO\u001b[0m] Processing chunk with 981596 records\n",
      "[2025-03-07T11:12:18Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      "100%|██████████| 65766932/65937541 [56:41<00:08, 19333.12it/s][2025-03-07T11:13:06Z \u001b[32mINFO\u001b[0m] Processing chunk with 170609 records\n",
      "[2025-03-07T11:13:06Z \u001b[32mINFO\u001b[0m] Sample record - Barcode present: true, UMI present: false, Read1 present: true, Read2 present: true\n",
      "100%|██████████| 65937541/65937541 [56:53<00:00, 19317.63it/s][2025-03-07T11:13:17Z \u001b[32mINFO\u001b[0m] Alignment process completed in 3580.02s\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "{'sequenced_reads': 131875082.0,\n",
       " 'frac_properly_paired': 0.8498182393547251,\n",
       " 'frac_mitochondrial': nan,\n",
       " 'num_unique_fragments': 0.0,\n",
       " 'frac_duplicates': nan,\n",
       " 'frac_fragment_in_nucleosome_free_region': nan,\n",
       " 'frac_confidently_mapped': nan,\n",
       " 'frac_unmapped': nan,\n",
       " 'frac_q30_bases_read1': 0.8275834390742883,\n",
       " 'frac_q30_bases_read2': 0.8165559236264723,\n",
       " 'frac_valid_barcode': 0.0,\n",
       " 'frac_fragment_flanking_single_nucleosome': nan,\n",
       " 'sequenced_read_pairs': 65937541.0,\n",
       " 'frac_q30_bases_barcode': 0.8074974962385236}"
      ]
     },
     "execution_count": 15,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "\n",
    "precellar.align(\n",
    "    assay,\n",
    "    modality='atac',\n",
    "    aligner=bwa,\n",
    "    output='/data2/litian/precellar_data//processed_file/20250307_scifi_out.fragment.tsv.zst',\n",
    "    output_type='fragment',\n",
    "    num_threads=32,\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e3073080-d830-4d92-b7f5-1fa5a2bfb171",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
